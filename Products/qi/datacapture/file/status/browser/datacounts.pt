<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/general/macros/master"
      i18n:domain="Products.qi">
<head>
</head>

<body>
    <div metal:fill-slot="main"
    	tal:define="upload view/getUpload">
    	<tal:details define="currentquery python:upload.tracked.measurementvalue_set.all();
                        historicalquery python:upload.tracked.measurementchange_set.all();
                        alldata python:view.alldata();
                        baselink python:'%s/viewdata?fileid=%s\x26%s'%(view.context.absolute_url(),upload.tracked.id,'%s=%s')">
    
    <h2 class="filetitle" tal:content="upload/tracked/displayname" />
    <table class="formattable">
        <tr>
            <td>Status:</td> <td> <b tal:content="upload/status"></b></td>
        </tr>
        <tr>
            <td>Time:</td> <td tal:content="python:view.niceifydt(upload.initiated)"> </td>
        </tr>
    </table>

    	<div class="spacemaker">
    	</div>
    	<h2 style="border-bottom-style: none;">Summary of Data Values Imported</h2>
    	<p class="descriptio">
            The tables below summarize the number of data values imported from this Ô¨Åle, broken down by 
            teams, measures, reporting periods and series.
    	</p>
    	<h3>Teams</h3>
    	<table class="listing">
    		<tr>
    			<th style="width: 4in;">Team</th>
    			<th style="width: 1.5in;">Number of values</th>
    		</tr>
    		<tal:teams repeat="teamgroup python:currentquery.values('team').distinct()">
    		<tal:meh
    					define="teamvalues python:alldata.filter(team=teamgroup['team']);
    							team python:view.DB().Team.objects.get(id=teamgroup['team'])">
    			<tr>
    				<td tal:content="team/name" />
    				<td>
    				    <tal:stuff 
    				        content="python:currentquery.filter(team=team).count() + \
    				        historicalquery.filter(value__in=teamvalues).count()" />
    					 <a tal:attributes="href python:baselink%('teamid',team.id)" >(view)</a>
    				</td>
    			</tr>
    		</tal:meh>
    		</tal:teams>
    	</table>

    	<h3>Measures</h3>
    	<table class="listing">
    		<tr>
    			<th style="width: 4in;">Measure</th>
    			<th style="width: 1.5in;">Number of Values</th>
    		</tr>
    		<tal:teams repeat="measuregroup python:currentquery.values('measure').distinct()">
    		<tal:meh
    					define="measurevalues python:alldata.filter(measure=measuregroup['measure']);
    							measure python:view.DB().Measure.objects.get(id=measuregroup['measure'])">
    			<tr>
    				<td tal:content="measure/name" />
    				<td>
    				    <tal:stuff 
    				        content="python:currentquery.filter(measure=measure).count() + \
    				        historicalquery.filter(value__in=measurevalues).count()" />
    					 <a tal:attributes="href python:baselink%('measureid',measure.id)" >(view)</a>
    				</td>
    			</tr>
    		</tal:meh>
    		</tal:teams>
    	</table>


    	<h3>Reporting Periods</h3>
    	<table class="listing">
    		<tr>
    			<th style="width: 4in;">Period</th>
    			<th style="width: 1.5in;">Count</th>
    		</tr>
    		<tal:teams repeat="dategroup python:currentquery.values('itemdate').distinct()">
    		<tal:meh define="datevalues python:alldata.filter(itemdate=dategroup['itemdate']) ;
    							itemdate python:dategroup['itemdate'];">
    			<tr>
    				<td tal:content="python:view.reformatdate(itemdate)" />
    				<td>
    				    <tal:stuff 
				            content="python:currentquery.filter(itemdate=itemdate).count() + \
    				        historicalquery.filter(value__in=datevalues).count()" /> 
    				    <a tal:attributes="href python:baselink%('itemdate',itemdate)" >(view)</a>
				    </td>
    			</tr>
    		</tal:meh>
    		</tal:teams>
    	</table>

    	<h3>Series</h3>
    	<table class="listing">
    		<tr>
    			<th style="width: 4in;">Series</th>
    			<th style="width: 1.5in;">Count</th>
    		</tr>
    		<tal:teams repeat="seriesgroup python:currentquery.values('series').distinct()">
    		<tal:meh
    					define="seriesvalues python:alldata.filter(series=seriesgroup['series']);
    							series python: seriesvalues and view.DB().Series.objects.get(id=seriesgroup['series'])
    								or None">
    			<tr>
    				<tal:isseries condition="series">
    					<td
    					 tal:content="python:'%s'%series.name" />
    					<td> <tal:stuff content="python:currentquery.filter(series=series).count() 
    					    + historicalquery.filter(value__in=seriesvalues).count()" />
    					    <a tal:attributes="href python:baselink%('series',series.name)" >(view)</a>
					    </td>
    				</tal:isseries>
    				<tal:noseries condition="not:series" define="seriesvalues python:alldata.filter(series__isnull=True);">
    					<td>Total population</td>
    					<td> <tal:stuff content="python:currentquery.filter(series__isnull=True).count() + \
    					historicalquery.filter(value__in=seriesvalues).count()" />
    					    <a tal:attributes="href python:baselink%('series','')" >(view)</a>
					    </td>
    				</tal:noseries>

    			</tr>
    		</tal:meh>
    		</tal:teams>
    	</table>
    	</tal:details>
    </div>
</body>
</html>
